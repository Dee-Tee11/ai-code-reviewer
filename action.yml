name: "AI Code Reviewer"
description: "Educational AI code reviewer with optional RAG context"
author: "Dee-Tee11"

inputs:
  huggingface_token:
    description: "HuggingFace API Token"
    required: true

  github_token:
    description: "GitHub Personal Access Token"
    required: true

  enable_rag:
    description: "Enable RAG (Retrieval-Augmented Generation) context. Set to 'true' to use existing ChromaDB."
    required: false
    default: "false"

  rag_db_path:
    description: "Path to existing ChromaDB database for RAG (must exist if enable_rag=true)"
    required: false
    default: "./chroma_db"

runs:
  using: "composite"
  steps:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ SETUP PYTHON
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: "pip"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“¦ INSTALL DEPENDENCIES
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: ğŸ“¦ Install dependencies
      shell: bash
      run: |
        echo "ğŸ“¦ Installing AI Code Reviewer dependencies..."
        pip install -q -r ${{ github.action_path }}/requirements.txt
        echo "âœ… Dependencies installed"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ§  VERIFY RAG DATABASE (SE ENABLED)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: ğŸ§  Verify RAG Database
      if: inputs.enable_rag == 'true'
      shell: bash
      run: |
        RAG_PATH="${{ inputs.rag_db_path }}"

        echo "ğŸ” Checking RAG database at: $RAG_PATH"

        if [ -d "$RAG_PATH" ] && [ -n "$(ls -A $RAG_PATH 2>/dev/null)" ]; then
          echo "âœ… RAG database found!"
          
          if [ -f "$RAG_PATH/chroma.sqlite3" ]; then
            DB_SIZE=$(du -sh $RAG_PATH 2>/dev/null | cut -f1 || echo "unknown")
            echo "ğŸ“Š Database size: $DB_SIZE"
          fi
          
          echo "ğŸ¯ Reviews will include context from your codebase"
        else
          echo "âš ï¸ WARNING: RAG enabled but database not found at $RAG_PATH"
          echo "ğŸ’¡ The action will NOT build RAG automatically."
          echo "ğŸ“ To fix this:"
          echo "   1. Run locally: python .rag/build.py"
          echo "   2. Commit: git add chroma_db/ && git commit -m 'ğŸ§  Add RAG database'"
          echo "   3. Push: git push"
          echo ""
          echo "âš¡ Review will proceed WITHOUT RAG context"
        fi

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ¤– RUN AI CODE REVIEWER
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: ğŸ¤– Run AI Code Reviewer
      shell: bash
      env:
        HUGGINGFACE_TOKEN: ${{ inputs.huggingface_token }}
        GITHUB_TOKEN: ${{ inputs.github_token }}
        ENABLE_RAG: ${{ inputs.enable_rag }}
        RAG_DB_PATH: ${{ inputs.rag_db_path }}
      run: |
        echo "ğŸš€ Starting AI Code Review..."
        python ${{ github.action_path }}/reviewer.py

branding:
  icon: "book-open"
  color: "blue"
